<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <script src="mqttws31.js" type="text/javascript"></script>
    <h4>My MQTT Map</h4>
    <form name="form1" action="javascript:void(0);">
        <button onclick="connect()">Connect!</button>
        <p id="main_text">Not connected</p>
        <!--The div element for the map -->
        <center>
            <iframe id="mmframe" src="http://maps.google.com/maps?output=embed&z=16&q=-22.817076,-47.069760" width="100%"
                height="350" frameborder="0" style="border:0" allowfullscreen></iframe>
            <textarea readonly name="mylog" style="width:100%;height:150px;"></textarea>
    </form>
    <script>
        var root_topic = '/guto';
        var location_topic = root_topic + '/rx/loc';
        var myid = btoa(Math.random()).substring(0,12);
        client = new Paho.MQTT.Client("test.mosquitto.org", 8080, myid);
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        function connect() {
            client.connect({ onSuccess: onConnect });
            write('Connecting... ID: '+myid);
        }

        function subscribe() {
            client.subscribe(location_topic);
            write('Subscribed to '+location_topic)
        }

        function onConnect() {
            write('Connected to test.mosquitto.org!');
            subscribe();
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                write('Connection Lost ' + responseObject.errorMessage);
            }
        }

        function onMessageArrived(message) {
            var dname = message.destinationName;
            if (dname == location_topic) {
                write('New message received! > ' + message.payloadString);
                var loc = eval("(" + message.payloadString + ')');
                if (loc) {
                    document.getElementById('mmframe').src = 'http://maps.google.com/maps?output=embed&z=16&q=' + loc.lat + ',' + loc.lng;
                }
            }
        }

        function write(text) {
            document.getElementById("main_text").innerHTML = text;
            form1.mylog.value += text + '\n';
            form1.mylog.scrollTop = form1.mylog.scrollHeight
        }


    </script>
    <!--Load the API from the specified URL
    * The async attribute allows the browser to render the page while the API loads
    * The key parameter will contain your own API key (which is not needed for this tutorial)
    * The callback parameter executes the initMap() function
    -->
</body>

</html>